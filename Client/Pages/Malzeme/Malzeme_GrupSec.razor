@page "/malzeme_grupsec"

<div class="container">

    <MudTable Items="@items" FixedFooter="true" FixedHeader="true" Dense="true" Hover="true" Bordered="true" Striped="true" Filter="new Func<SpeCodesDto,bool>(FilterFunc1)">
        <ToolBarContent>
            <MudText Typo="Typo.h6">Malzeme Grupları</MudText>
            <MudTextField @bind-Value="_searchString" Placeholder="Grup Ara" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
        </ToolBarContent>
        <HeaderContent>
            <MudTh>#</MudTh>
            <MudTh>Kodu</MudTh>
            <MudTh>Adı</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd>
                <MudFab Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" Size="Size.Small" OnClick="(() => Sec(context.LOGICALREF,context.SPECODE,context.DEFINITION_))" />
            </MudTd>
            <MudTd DataLabel="Kodu">@context.SPECODE</MudTd>
            <MudTd DataLabel="Adı">@context.DEFINITION_</MudTd>
        </RowTemplate>
        <PagerContent>
            <MudTablePager RowsPerPageString="Sayfa başına kayıt sayısı" />
        </PagerContent>
    </MudTable>
</div>

@code
{
    [CascadingParameter] IModalService modal { get; set; }
    [CascadingParameter] BlazoredModalInstance ModalInstance { get; set; }

    [Inject]
    ILocalStorageService LocalStorageService { get; set; }

    [Inject]
    HttpClient httpClient { get; set; }

    public List<SpeCodesDto> items { get; set; }
    private string _searchString;
    private bool _sortNameByLength;
    private bool loadingCompleted = false;

    private bool FilterFunc1(SpeCodesDto element) => FilterFunc(element, _searchString);

    private bool FilterFunc(SpeCodesDto element, string searchString)
    {
        if (string.IsNullOrWhiteSpace(searchString))
            return true;
        if (element.DEFINITION_ != null && element.DEFINITION_.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        return false;
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadList();
    }

    private async Task LoadList()
    {
        var selectedFirmaDonem = await LocalStorageService.GetItemAsync<SisFirmaDonemDto>(Consts.FirmaDonem);

        items = await httpClient.GetServiceResponseAsync<List<SpeCodesDto>>("/api/malzemekart/GetGrupList?logofirmno=" + selectedFirmaDonem.logo_firma.Value);
    }

    public async Task Sec(int logref, string kodu, string adi)
    {
        var selectedFirmaDonem = await LocalStorageService.GetItemAsync<SisFirmaDonemDto>(Consts.FirmaDonem);

        var res = new SpeCodesDto();
        res.LOGICALREF = logref;
        res.SPECODE = kodu;
        res.DEFINITION_ = adi;

        await ModalInstance.CloseAsync(ModalResult.Ok<SpeCodesDto>(res));
    }

}